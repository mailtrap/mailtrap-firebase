name: mailtrap-email
version: 1.0.0
specVersion: v1beta

displayName: Send Email with Mailtrap
description: >-
  Sends emails via Mailtrap API when documents are created in a
  specified Cloud Firestore collection. Supports templates, attachments,
  and delivery status tracking.

license: Apache-2.0

icon: icon.png

author:
  authorName: Mailtrap
  url: https://mailtrap.io

sourceUrl: https://github.com/mailtrap/mailtrap-firebase-extension
releaseNotesUrl: https://github.com/mailtrap/mailtrap-firebase-extension/blob/main/CHANGELOG.md

billingRequired: true

roles:
  - role: datastore.user
    reason: Allows this extension to read and update email documents in Firestore.

resources:
  - name: processQueue
    type: firebaseextensions.v1beta.v2function
    description: >-
      Processes document writes in the specified Cloud Firestore collection,
      delivers emails via Mailtrap, and updates documents with delivery status.
    properties:
      location: ${FUNCTION_LOCATION}
      buildConfig:
        runtime: nodejs22
      serviceConfig:
        timeoutSeconds: 60
        availableMemory: 256Mi
      eventTrigger:
        eventType: google.cloud.firestore.document.v1.created
        triggerRegion: ${DATABASE_LOCATION}
        eventFilters:
          - attribute: database
            value: (default)
          - attribute: document
            value: ${param:MAIL_COLLECTION}/{documentId}
            operator: match-path-pattern

params:
  - param: FUNCTION_LOCATION
    label: Cloud Functions location
    description: >-
      Where do you want to deploy the functions created for this extension?
      For help selecting a location, refer to the
      [location selection guide](https://firebase.google.com/docs/functions/locations).
    type: string
    default: us-central1
    required: true
    immutable: true

  - param: DATABASE_LOCATION
    label: Firestore database location
    description: >-
      Where is your Firestore database located? The event trigger must be
      in the same region as the database. For multi-region US use `nam5`,
      for multi-region EU use `eur3`. Refer to the
      [Firestore locations guide](https://firebase.google.com/docs/firestore/locations).
    type: string
    default: nam5
    required: true
    immutable: true

  - param: MAILTRAP_API_TOKEN
    label: Mailtrap API Token
    description: >-
      Your Mailtrap API token for sending emails.
      Get it from https://mailtrap.io/api-tokens
    type: secret
    required: true

  - param: MAIL_COLLECTION
    label: Email documents collection
    description: >-
      Path to the Firestore collection where email documents will be written.
    type: string
    default: mail
    validationRegex: "^[^/]+(/[^/]+/[^/]+)*$"
    validationErrorMessage: Must be a valid Cloud Firestore collection path.
    required: true

  - param: DEFAULT_FROM_EMAIL
    label: Default FROM email address
    description: >-
      Default sender email address used when not specified in the document.
    type: string
    example: noreply@example.com
    validationRegex: "^.+@.+\\..+$"
    validationErrorMessage: Must be a valid email address.
    required: true

  - param: DEFAULT_FROM_NAME
    label: Default FROM name
    description: >-
      Default sender name used when not specified in the document (optional).
    type: string
    example: My App
    required: false
